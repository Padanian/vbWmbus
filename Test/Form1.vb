Imports vbWmbusNameSpace.vbWmbus

Public Class Form1

    Public add As New vbWmbusNameSpace.vbWmbus


    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles Button1.Click

        'Dim telegramma As String = "2644C5148003602400077A912B00202F2F046D252A562B0413DF00000001FD17400478A1DBB90000"
        'Dim telegramma As String = "2844C5148910504301167289105043C5140016D22B00202F2F046D19295C2B0413E800000001FD17580097FC"
        'Dim telegramma As String = "5244C51445195824010D7A4F2000202F2F046D2B275C2B0406000000008410060000000001FD1700041501000000043B00000000042B00000000025F140004610300000084401410000000848040140000000000"
        'Dim telegramma As String = "2844C5149310504301167210010000C51400162B2B00202F2F046D18295C2B0413F900000001FD1758005000"
        'Dim telegramma As String = "2B44C5144735902455087247359024C5145508560000002F2F0B6E000000426C3F2C4B6E00000002FD17000000DF21C6"
        'Dim telegramma As String = "E344E3102290980601087AD30A00000F01F9162B450040000000000000A10100D700000000000000000000000000000000000000000000002E00004600006500006F00004A00000F00000000000000000000000000001200000400002A00005A00006A0000590000420000D9000701D000FC0014012B015C01430143013D01300157023D025E02740249023D022D015E014C01520136021E02350245025C025A02450208011C014801310132012D0120013E013E0175017201570102011F014B013C0142012A01020111014D014C012C012801A5413D2129AB4A214D70D6F9CC128005C900000000000000"
        'Dim telegramma As String = "5044243434398583000D7A9B0000202F2F046D01295D2B0406000000008410060000000001FD1710041303000000043B00000000042B00000000025B1700025F17000261080003FD0C05000002FD0B301100F285"
        'Dim telegramma As String = "A946243490678584000D7A6000900502AA7C4110B3FFFF60C1558FBF2F6FE4FCA3D5C2623B5B6C8C1DA5C7E9F414733AA40375E2A302946670539337C035C08F6F76D4FC1AC64A85DE8D84D467519F587290FC85134F1CAD7885DE5D031958DCE805E4FE91598DD64B353916FD59FCE8B9C4198DA371DCC8F36918989A4F61ED9DB8C0EC393B74076C81F900859CEC61A4478030E9B24C7C4E76D549C9D74F03FD0C06000002FD0B11210013"'
        'Dim telegramma As String = "A946243490678584000D7A6000900518EDDD8AC94075F0C38E928328A325C0CBC430ACDFC1A23EF51893F46AEE29C17B9C7337818F5EBA36DD2139200D55C53EBCA5E58DD3CC6E7A6A7F37BE5D046769927B4C299AD0669D7DE769F28BBD4C70FA545E0C6BAB9809422B3C8B600E1946D68156AE70E2FD629C21963BA4777EABB32C40E7A3DE58F90BA8C2BDE3CE90D3846BCF439D622634720D993A9DDD3F03FD0C06000002FD0B11220013"'
        'Dim telegramma As String = "A944243486678584000D7A1D00902594AA5ABC80FB05675B4D4C76B6C376BFA3DD67FE8A87BFCB0F763CA4315051B650F355C5AFFEB7673B99DB9021C1EF4DDE5BCA7CEAC04B62538ED38A0FF2E470F245C60BACB7B4F86E813669DE7771245102997AD3B45BB433B11815D0B2365EA61D36638949B21CF4285B9E45FCAF98A1984FCF9611CFB14DEBFC808C8E5435972F4741D1E0B6B2B9A8AF059CAEA04603FD0C06000002FD0B1121000000"

        'Dim telegramma As String = "A944243486678584000D7A1D0090252f2f046d1d2d542c04060e0000000413ca01000001fd1700426c0000440600000000c4010600000000c4020600000000c4030600000000c4040600000000c4050600000000c4060600000000c4070600000000c4080600000000c4090600000000c40a0600000000c40b0600000000c40c0600000000c40d0600000000c40e0600000000"
        Dim telegramma As String = "1A442434810726024412A2CD0D0013B243DB72B5B25CF4D55BC62A"
        Dim de = add.MainVBWMBUS(telegramma)


        If SerialPort1.IsOpen = False Then
            SerialPort1.Open()
            Dim stringaInit = "FF097A00780080710200000000FFFF8000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF003200021400FFFFFFFFFF010004000000FFFFFF01440000000000000000FFFF0C050200FFFFFFFFFF01080000FFFFFFFFFFFFFF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE1"
            Dim commandInit(125) As Byte
            Dim indiceArray As Integer = 0
            While (2 * indiceArray + 1) <= Len(stringaInit)

                commandInit(indiceArray) = CByte(Convert.ToInt32(Microsoft.VisualBasic.Strings.Mid(stringaInit, 2 * indiceArray + 1, 2), 16))
                indiceArray = indiceArray + 1

            End While

            SerialPort1.Write(commandInit, 0, indiceArray)

        End If


    End Sub
    Public Sub SerialPort1_DataReceived(ByVal sender As Object, ByVal e As System.IO.Ports.SerialDataReceivedEventArgs) Handles SerialPort1.DataReceived

        Dim buf As Byte() = {}                                          'allocate a buffer
        Dim dataLock As New Object


        Try


            While SerialPort1.BytesToRead > 0
                Array.Resize(buf, buf.Length + 1)
                buf(buf.Length - 1) = SerialPort1.ReadByte
                Threading.Thread.Sleep(2)
            End While

            Threading.Monitor.Enter(dataLock)                                       ' protect the buffer


            If Not buf.SequenceEqual({}) Then

                Dim str As String = ""
                For b = 0 To buf.Length - 1
                    str = str & Hex(buf(b)).PadLeft(2, "0").ToUpper
                Next

                If str = "FF89010077" Then
                    'MsgBox("initialised succesfully")
                    Exit Sub
                End If

                Dim lengthByte = buf(0)
                If buf.Length - 1 <> lengthByte Then
                    Exit Sub '1 byte ogni tre caratteri del telegramma. Se la lunghezza del telegramma non è multiplo di 3 caratteri, esci
                End If

                Dim commandByte = buf(1)
                If commandByte <> 68 Then
                    Exit Sub                         'se il CField è diverso da 44, il telegramma non ci interessa
                End If


                Dim de = add.MainVBWMBUS(str)


                If de IsNot Nothing Then Display(de.Item2)

                Threading.Monitor.Exit(dataLock)                                        ' release buffer protection

            End If

        Catch ex As Exception
            MsgBox(ex.Message)
            Threading.Monitor.Exit(dataLock)                                        ' release buffer protection
            Exit Sub
        End Try

    End Sub
    Private Sub Display(ByVal str As String)
        If Me.InvokeRequired Then
            Me.Invoke(Sub() Display(str))
            Return
        End If
        RichTextBox1.Text = str
    End Sub

End Class